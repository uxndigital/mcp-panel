name: Deploy MCP Panel to Production

on:
  push:
    branches: ['main']
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    outputs:
      REPO_NAME: ${{ steps.output_REPO_NAME.outputs.REPO_NAME }}
      BUILD_SUCCESS: ${{ steps.build_check.outputs.BUILD_SUCCESS }}
    env:
      PATH: /bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/home/${{ secrets.SERVER_USERNAME }}/.nvm/versions/node/v22.14.0/bin:/home/${{ secrets.SERVER_USERNAME }}/.local/share/pnpm:$PATH
      DEPLOY_ENV: production
      DEPLOY_ROOT: ${{ vars.DEPLOY_ROOT }}
    
    steps:
      - name: æ£€æŸ¥ç”¨æˆ·å’Œç¯å¢ƒ
        run: |
          echo "===== ç¯å¢ƒæ£€æŸ¥ ====="
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "ç”¨æˆ·ID: $(id)"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ä¸»ç›®å½•: $HOME"
          echo "Node.js ç‰ˆæœ¬: $(node --version)"
          echo "pnpm ç‰ˆæœ¬: $(pnpm --version)"
          echo "Git ç‰ˆæœ¬: $(git --version)"
          
          # è®¾ç½®ä»“åº“ä¿¡æ¯
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          echo "ä»“åº“åç§°: $REPO_NAME"
          echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"

      - name: è®¾ç½®ä»“åº“åç§°ç¯å¢ƒå˜é‡
        id: output_REPO_NAME
        run: |
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ ä»“åº“åç§°: $REPO_NAME"
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3 # docs https://pnpm.io/continuous-integration#github-actions
        with:
          version: 9.1.0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: è·å– pnpm store è·¯å¾„
        id: pnpm-store-path
        run: |
          STORE_PATH=$(pnpm store path)
          echo "path=$STORE_PATH" >> $GITHUB_OUTPUT
          echo "ğŸ“ pnpm store è·¯å¾„: $STORE_PATH"

      - name: Git ä»“åº“è®¾ç½®å’Œä»£ç åŒæ­¥
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          
          echo "===== Git ä»“åº“è®¾ç½® ====="
          
          # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
          mkdir -p $DEPLOY_PATH
          echo "âœ… éƒ¨ç½²ç›®å½•å·²åˆ›å»º: $DEPLOY_PATH"

          # æ£€æŸ¥æ˜¯å¦ä¸º Git ä»“åº“
          if [ ! -d "$DEPLOY_PATH/.git" ]; then
            echo "ğŸ”„ åˆå§‹åŒ– Git ä»“åº“"
            cd $DEPLOY_PATH
            git init
            git remote add origin git@github.com:$GITHUB_REPOSITORY.git
            echo "âœ… Git ä»“åº“åˆå§‹åŒ–å®Œæˆ"
          else
            echo "âœ… Git ä»“åº“å·²å­˜åœ¨"
          fi

          cd $DEPLOY_PATH
          # è®¾ç½®å®‰å…¨ç›®å½•
          git config --global --add safe.directory $DEPLOY_PATH
          
          echo "ğŸ”„ åŒæ­¥ä»£ç ..."
          # ä½¿ç”¨ fetch å’Œ reset ä»£æ›¿ pull ä»¥é¿å…å†²çª
          git fetch origin ${GITHUB_REF#refs/heads/}
          git reset --hard origin/${GITHUB_REF#refs/heads/}
          echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
          
          echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
          ls -lash

      - name: å®‰è£…ä¾èµ–
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          cd $DEPLOY_PATH
          
          echo "===== å®‰è£…ä¾èµ– ====="
          
          # å¤„ç†éƒ¨ç½²ç‰¹å®šçš„é”æ–‡ä»¶
          if [ -f "./pnpm-lock.deploy.yaml" ]; then
            echo "ğŸ”„ ä½¿ç”¨éƒ¨ç½²ä¸“ç”¨é”æ–‡ä»¶"
            mv ./pnpm-lock.deploy.yaml ./pnpm-lock.yaml
          fi
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ä¾èµ–ä¸­..."
          pnpm install --frozen-lockfile
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          
          # éªŒè¯å…³é”®ä¾èµ–
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–:"
          if [ -d "node_modules/@modelcontextprotocol" ]; then
            echo "âœ… MCP SDK ä¾èµ–å·²å®‰è£…"
          else
            echo "âŒ MCP SDK ä¾èµ–ç¼ºå¤±"
          fi
          
          if [ -d "node_modules/express" ]; then
            echo "âœ… Express ä¾èµ–å·²å®‰è£…"
          else
            echo "âŒ Express ä¾èµ–ç¼ºå¤±"
          fi

      - name: æ„å»ºé¡¹ç›®
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          cd $DEPLOY_PATH
          
          echo "===== æ„å»ºé¡¹ç›® ====="
          export DEPLOY_ENV=production
          
          # æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
          echo "ğŸ§¹ æ¸…ç†æ—§æ„å»ºäº§ç‰©"
          rm -rf api-server/dist web-app/dist packages/mcp-server/dist
          
          # æ„å»ºé¡¹ç›®
          echo "ğŸ—ï¸ å¼€å§‹æ„å»º..."
          pnpm run build
          echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"

      - name: éªŒè¯æ„å»ºç»“æœ
        id: build_check
        run: |
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          cd $DEPLOY_PATH
          
          echo "===== éªŒè¯æ„å»ºç»“æœ ====="
          BUILD_FAILED=0
          
          # æ£€æŸ¥ API Server æ„å»º
          if [ -d "api-server/dist" ] && [ -f "api-server/dist/api-server/src/index.js" ]; then
            echo "âœ… API Server æ„å»ºæˆåŠŸ"
            ls -la api-server/dist/
          else
            echo "âŒ API Server æ„å»ºå¤±è´¥"
            BUILD_FAILED=1
          fi
          
          # æ£€æŸ¥ Web App æ„å»º
          if [ -d "web-app/dist" ] && [ -f "web-app/dist/index.html" ]; then
            echo "âœ… Web App æ„å»ºæˆåŠŸ"
            ls -la web-app/dist/
          else
            echo "âŒ Web App æ„å»ºå¤±è´¥"
            BUILD_FAILED=1
          fi
          
          # æ£€æŸ¥ MCP Server æ„å»º
          if [ -d "packages/mcp-server/dist" ]; then
            echo "âœ… MCP Server æ„å»ºæˆåŠŸ"
            ls -la packages/mcp-server/dist/
          else
            echo "âŒ MCP Server æ„å»ºå¤±è´¥"
            BUILD_FAILED=1
          fi
          
          # æ£€æŸ¥ PM2 é…ç½®æ–‡ä»¶
          if [ -f "ecosystem.config.cjs" ]; then
            echo "âœ… PM2 é…ç½®æ–‡ä»¶å­˜åœ¨"
          else
            echo "âŒ PM2 é…ç½®æ–‡ä»¶ç¼ºå¤±"
            BUILD_FAILED=1
          fi
          
          if [ $BUILD_FAILED -eq 0 ]; then
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "ğŸ‰ æ‰€æœ‰æ„å»ºéªŒè¯é€šè¿‡"
          else
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
            echo "ğŸ’¥ æ„å»ºéªŒè¯å¤±è´¥"
            exit 1
          fi

  # éƒ¨ç½²ä½œä¸š
  deploy:
    needs: build
    runs-on: centos2-vs-com
    if: needs.build.outputs.BUILD_SUCCESS == 'true'
    env:
      DEPLOY_ROOT: ${{ vars.DEPLOY_ROOT }}
      BASE_PATH: ${{ vars.BASE_PATH }}
      PATH: /bin:/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/sbin:/home/${{ secrets.SERVER_USERNAME }}/.nvm/versions/node/v22.14.0/bin:/home/${{ secrets.SERVER_USERNAME }}/.local/share/pnpm:$PATH
    
    steps:
      - name: PM2 éƒ¨ç½²åº”ç”¨
        env:
          DEPLOY_ENV: production
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${{ needs.build.outputs.REPO_NAME }}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}
          cd $DEPLOY_PATH
          
          echo "===== PM2 éƒ¨ç½²åº”ç”¨ ====="
          echo "ä»“åº“åç§°: $REPO_NAME"
          echo "éƒ¨ç½²è·¯å¾„: $DEPLOY_PATH"

          if [ -f "ecosystem.config.cjs" ]; then
            echo "âœ… ä½¿ç”¨ ecosystem.config.cjs é…ç½®æ–‡ä»¶"
            
            # æ˜¾ç¤ºå½“å‰ PM2 çŠ¶æ€
            echo "ğŸ” å½“å‰ PM2 çŠ¶æ€:"
            pm2 status || echo "PM2 å¯èƒ½è¿˜æ²¡æœ‰è¿è¡Œçš„åº”ç”¨"
            
            # åœæ­¢å¹¶åˆ é™¤ç°æœ‰åº”ç”¨
            echo "ğŸ›‘ åœæ­¢ç°æœ‰åº”ç”¨"
            pm2 stop ecosystem.config.cjs || true
            pm2 delete ecosystem.config.cjs || true
            
            # å¯åŠ¨æ–°åº”ç”¨
            echo "ğŸš€ å¯åŠ¨æ–°åº”ç”¨"
            pm2 start ecosystem.config.cjs --env ${DEPLOY_ENV} --update-env
            
            # æ˜¾ç¤ºåº”ç”¨é…ç½®
            echo "ğŸ“‹ PM2 åº”ç”¨é…ç½®:"
            node -e "console.log(JSON.stringify(require('./ecosystem.config.cjs'), null, 2))"
            
          else
            echo "âŒ æœªæ‰¾åˆ° ecosystem.config.cjs é…ç½®æ–‡ä»¶"
            echo "ğŸ”„ ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨"
            
            # åœæ­¢ç°æœ‰åº”ç”¨
            pm2 stop ${REPO_NAME} || true
            pm2 delete ${REPO_NAME} || true
            
            # ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
            pm2 start "pnpm start" --name ${REPO_NAME}
          fi
          
          # é‡ç½®åº”ç”¨ç»Ÿè®¡
          pm2 reset all || true
          echo "âœ… PM2 éƒ¨ç½²å®Œæˆ"

      - name: ç­‰å¾…åº”ç”¨å¯åŠ¨
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${{ needs.build.outputs.REPO_NAME }}
          
          echo "===== ç­‰å¾…åº”ç”¨å¯åŠ¨ ====="
          echo "â³ ç­‰å¾…åº”ç”¨å®Œå…¨å¯åŠ¨ (10ç§’)"
          sleep 10
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "ğŸ“Š å½“å‰ PM2 çŠ¶æ€:"
          pm2 status

      - name: ç›‘æ§åº”ç”¨å¯åŠ¨æ—¥å¿—
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${{ needs.build.outputs.REPO_NAME }}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}

          echo "===== ç›‘æ§åº”ç”¨å¯åŠ¨æ—¥å¿— (15ç§’) ====="
          cd $DEPLOY_PATH
          
          # æ¸…é™¤æ—§æ—¥å¿—
          pm2 flush all || true
          echo "ğŸ§¹ å·²æ¸…é™¤æ—§æ—¥å¿—"
          
          # ç­‰å¾…æ—¥å¿—ç”Ÿæˆ
          sleep 3
          
          # è·å–åº”ç”¨æ—¥å¿—
          echo "ğŸ“ è·å–åº”ç”¨æ—¥å¿—:"
          pm2 logs --lines 50 --raw &
          LOG_PID=$!
          
          # ç›‘æ§ 15 ç§’
          sleep 15
          
          # ç»ˆæ­¢æ—¥å¿—è¿›ç¨‹
          kill $LOG_PID 2>/dev/null || true
          echo "âœ… æ—¥å¿—ç›‘æ§å®Œæˆ"

      - name: åº”ç”¨å¥åº·æ£€æŸ¥
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${{ needs.build.outputs.REPO_NAME }}
          DEPLOY_PATH=$DEPLOY_ROOT/${REPO_NAME}

          echo "===== åº”ç”¨å¥åº·æ£€æŸ¥ ====="
          cd $DEPLOY_PATH
          
          # æ£€æŸ¥ PM2 åº”ç”¨çŠ¶æ€
          echo "ğŸ” PM2 åº”ç”¨çŠ¶æ€:"
          pm2 status
          
          # æ£€æŸ¥å…·ä½“åº”ç”¨çŠ¶æ€
          HEALTH_CHECK_FAILED=0
          
          # æ£€æŸ¥ API Server
          if pm2 show mcp-api-server 2>/dev/null | grep -q "online"; then
            echo "âœ… API Server (mcp-api-server) è¿è¡Œæ­£å¸¸"
            API_MEMORY=$(pm2 show mcp-api-server | grep memory | awk '{print $4}' || echo 'unknown')
            API_CPU=$(pm2 show mcp-api-server | grep cpu | awk '{print $2}' || echo 'unknown')
            echo "   ğŸ“Š å†…å­˜ä½¿ç”¨: $API_MEMORY"
            echo "   ğŸ”§ CPUä½¿ç”¨: $API_CPU"
          else
            echo "âŒ API Server (mcp-api-server) è¿è¡Œå¼‚å¸¸"
            HEALTH_CHECK_FAILED=1
          fi
          
          # æ£€æŸ¥ Web App
          if pm2 show mcp-web-app 2>/dev/null | grep -q "online"; then
            echo "âœ… Web App (mcp-web-app) è¿è¡Œæ­£å¸¸"
            WEB_MEMORY=$(pm2 show mcp-web-app | grep memory | awk '{print $4}' || echo 'unknown')
            WEB_CPU=$(pm2 show mcp-web-app | grep cpu | awk '{print $2}' || echo 'unknown')
            echo "   ğŸ“Š å†…å­˜ä½¿ç”¨: $WEB_MEMORY"
            echo "   ğŸ”§ CPUä½¿ç”¨: $WEB_CPU"
          else
            echo "âŒ Web App (mcp-web-app) è¿è¡Œå¼‚å¸¸"
            HEALTH_CHECK_FAILED=1
          fi
          
          # ç½‘ç»œç«¯å£æ£€æŸ¥
          echo "ğŸŒ ç½‘ç»œç«¯å£æ£€æŸ¥:"
          if netstat -tlnp 2>/dev/null | grep ":9906 " > /dev/null; then
            echo "âœ… API Server ç«¯å£ 9906 å·²å¼€æ”¾"
          else
            echo "âŒ API Server ç«¯å£ 9906 æœªå¼€æ”¾"
            HEALTH_CHECK_FAILED=1
          fi
          
          if netstat -tlnp 2>/dev/null | grep ":9905 " > /dev/null; then
            echo "âœ… Web App ç«¯å£ 9905 å·²å¼€æ”¾"
          else
            echo "âŒ Web App ç«¯å£ 9905 æœªå¼€æ”¾"
            HEALTH_CHECK_FAILED=1
          fi
          
          # HTTP å¥åº·æ£€æŸ¥
          echo "ğŸ’š HTTP å¥åº·æ£€æŸ¥:"
          if curl -f -s -m 10 http://localhost:9906/health > /dev/null; then
            echo "âœ… API Server å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ API Server å¥åº·æ£€æŸ¥å¤±è´¥"
            HEALTH_CHECK_FAILED=1
          fi
          
          # æ€»ç»“å¥åº·æ£€æŸ¥ç»“æœ
          if [ $HEALTH_CHECK_FAILED -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "ğŸ’¥ å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜"
            exit 1
          fi

      - name: éƒ¨ç½²ç»“æœæ€»ç»“
        if: always()
        run: |
          source /home/${{ secrets.SERVER_USERNAME }}/.bashrc
          REPO_NAME=${{ needs.build.outputs.REPO_NAME }}
          
          echo "===== MCP Panel éƒ¨ç½²ç»“æœæ€»ç»“ ====="
          echo "ğŸ• éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ“¦ é¡¹ç›®åç§°: $REPO_NAME"
          echo "ğŸ”„ Git åˆ†æ”¯: ${GITHUB_REF#refs/heads/}"
          echo "ğŸ’» è¿è¡Œç¯å¢ƒ: centos2-vs-com"
          
          # æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
          FINAL_STATUS="æˆåŠŸ"
          
          if ! pm2 show mcp-api-server 2>/dev/null | grep -q "online"; then
            FINAL_STATUS="å¤±è´¥"
          fi
          
          if ! pm2 show mcp-web-app 2>/dev/null | grep -q "online"; then
            FINAL_STATUS="å¤±è´¥"
          fi
          
          echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€: $FINAL_STATUS"
          
          if [ "$FINAL_STATUS" = "æˆåŠŸ" ]; then
            echo ""
            echo "ğŸ‰ MCP Panel éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ“Š API Server: http://localhost:9906"
            echo "ğŸŒ Web App: http://localhost:9905"
            echo "ğŸ’š å¥åº·æ£€æŸ¥: http://localhost:9906/health"
            echo "ğŸ“‹ MCP ç®¡ç†: http://localhost:9905"
            echo ""
            echo "ğŸ”§ ç®¡ç†å‘½ä»¤:"
            echo "  - æŸ¥çœ‹çŠ¶æ€: pm2 status"
            echo "  - æŸ¥çœ‹æ—¥å¿—: pm2 logs"
            echo "  - é‡å¯æœåŠ¡: pm2 restart ecosystem.config.cjs"
            echo "  - åœæ­¢æœåŠ¡: pm2 stop ecosystem.config.cjs"
          else
            echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯"
            exit 1
          fi
          
          echo "===== éƒ¨ç½²å®Œæˆ ====="